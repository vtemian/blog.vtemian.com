<html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,minimum-scale=1"><meta content="serverless hosting platforma,knative on bare metal,kubernetes on bare metal,tekton and knative" name=keywords><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/styles/atom-one-light.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/highlight.min.js></script><meta name=keywords content="serverless hosting platforma,knative on bare metal,kubernetes on bare metal,tekton and knative"><meta name=description content="favorite superpower: having awesome friends"><meta charset=utf-8><meta name=robots content="index,follow"><meta property="og:url" content="https://blog.vtemian.com/post/serverless-hosting-platform/"><meta property="og:site_name" content="vtemian - blog"><meta property="og:title" content="Building a serverless hosting platform"><meta property="og:description" content="Deploying a 3-tier application (with the presentation layer, business logic, and storage) can get a little tricky these days. Let’s say that we have a simple Django application, poll’s app from the tutorial. It runs perfect on our local machine, we added a requirements.txt to hold our dependencies. As for the database, we can use SQLite, since we’re developing only locally. The purpose of this project is to build a system that will allow us to push on a branch and deploy our changes in a separate environment, giving us a unique URL, to check them. Similarly to how now.sh and heroku.com are doing. We’ll need a mechanism that will package our code and dependencies and will deploy it, but also it needs to consider multiple versions, upgrades, load-balacing, scaling and our stateful part (database)."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-05-18T13:06:21+02:00"><meta property="article:modified_time" content="2020-05-18T13:06:21+02:00"><meta property="article:tag" content="Knative"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Serverless"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.vtemian.com\/"},"articleSection":"post","name":"Building a serverless hosting platform","headline":"Building a serverless hosting platform","description":"\u003cp\u003eDeploying a 3-tier application (with the presentation layer, business logic, and storage) can get a little tricky these days. Let\u0026rsquo;s say that we have a simple Django application, \u003ca href=\u0022https:\/\/github.com\/vtemian\/simple-django-app\u0022\u003epoll\u0026rsquo;s app\u003c\/a\u003e from the tutorial. It runs perfect on our local machine, we added a requirements.txt to hold our dependencies. As for the database, we can use SQLite, since we\u0026rsquo;re developing only locally. The purpose of this project is to build a system that will allow us to push on a branch and deploy our changes in a separate environment, giving us a unique URL, to check them. Similarly to how \u003ca href=\u0022http:\/\/now.sh\u0022\u003enow.sh\u003c\/a\u003e and \u003ca href=\u0022http:\/\/heorku.com\u0022\u003eheroku.com\u003c\/a\u003e are doing. We\u0026rsquo;ll need a mechanism that will package our code and dependencies and will deploy it, but also it needs to consider multiple versions, upgrades, load-balacing, scaling and our stateful part (database).\u003c\/p\u003e","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2020","datePublished":"2020-05-18 13:06:21 \u002b0200 \u002b0200","dateModified":"2020-05-18 13:06:21 \u002b0200 \u002b0200","url":"https:\/\/blog.vtemian.com\/post\/serverless-hosting-platform\/","wordCount":"5705","keywords":["knative","kubernetes","serverless","Blog"]}</script><title>Building a serverless hosting platform</title>
<link href="https://fonts.googleapis.com/css?family=Karla:700,Rubik:400,400i,Inconsolata:400" rel=stylesheet><link rel=stylesheet href=https://blog.vtemian.com/output/index.css media=screen><script type=text/javascript src=https://blog.vtemian.com/output/index.js crossorigin=anonymous defer></script><meta name=google-site-verification content="2qk_e0y84NNSVpaorKgeNURYF9Ni3UyJvPq9GZdGEgs"></head><body><div class="container container--is-large"><main class=article><article><header><a href=https://blog.vtemian.com/>&larr; Go back</a><h1>Building a serverless hosting platform</h1><aside class="author author--is-small"><img src=https://blog.vtemian.com/output/avatar.png><div><h4>Vlad Temian</h4><p>18 May 2020</p></div></aside></header><p><p>Deploying a 3-tier application (with the presentation layer, business logic, and storage) can get a little tricky these days. Let&rsquo;s say that we have a simple Django application, <a href=https://github.com/vtemian/simple-django-app>poll&rsquo;s app</a> from the tutorial. It runs perfect on our local machine, we added a requirements.txt to hold our dependencies. As for the database, we can use SQLite, since we&rsquo;re developing only locally. The purpose of this project is to build a system that will allow us to push on a branch and deploy our changes in a separate environment, giving us a unique URL, to check them. Similarly to how <a href=http://now.sh>now.sh</a> and <a href=http://heorku.com>heroku.com</a> are doing. We&rsquo;ll need a mechanism that will package our code and dependencies and will deploy it, but also it needs to consider multiple versions, upgrades, load-balacing, scaling and our stateful part (database).</p><p><a href=#introduction>Introduction</a></p><p><a href=#serving-component>Serving component</a></p><ul><li><a href=#packet>Packet</a></li><li><a href=#kubernetes-on-bare-metal>Kubernetes on bare-metal</a></li><li><a href=#metallb>MetalLB</a></li><li><a href=#istio>Istio</a></li><li><a href=#first-knative-service>First Knative service</a></li><li><a href=#elasticsearch-and-kibana>ElasticSearch and Kibana</a></li><li><a href=#autoscaling>Autoscaling</a></li><li><a href=#mysql>Mysql</a></li></ul><p><a href=#ci-cd>CI/CD</a></p><ul><li><a href=#tekton>Tekton</a></li><li><a href=#how-does-tekton-work>How does Tekton work?</a></li><li><a href=#pipeline-setup>Pipeline Setup</a></li><li><a href=#github-webhook-trigger>Github webhook trigger</a></li></ul><p><a href=#conclusions>Conclusions</a></p><h2 id=introduction>Introduction</h2><p>In order to achieve that, we&rsquo;ll need two main components: one component that will take our code and prepare it to be published, namely the CI/CD component, and another one that will expose the changes to the Internet, namely the serving component. We can add a third component to hold some state for our application, like database and storage, but we&rsquo;ll add it to the serving component.</p><p><img src=https://blog.vtemian.com/Untitled.png alt=/></p><h2 id=serving-component>Serving component</h2><p>For the serving component, we can use <a href=https://knative.dev/>Knative</a>. It leverages Kubernetes and integrates components that are already built on top of Kubernetes. At it&rsquo;s very basic, it runs and exposes a Docker image to the Internet, without any fuss. You&rsquo;ll just have to define a <code>service</code> that describe your image and its environment and Knative will take care of everything else (from routing, logging, monitoring to managing different versions of your application and autoscaling, including 0 scaling for no use).</p><p>As you can imagine, <a href=https://knative.dev/>Knative</a> is way more complex than it can be described in a paragraph and currently, we&rsquo;ll not dissect it.</p><h3 id=packet>Packet</h3><p>In order to move forward with Knative, we&rsquo;ll need a Kubernetes cluster. For the sake of over-engineering it and trying something new, let&rsquo;s try to install Kubernetes on bare-metal. It sounds a little overwhelming, but in the end, it is way simpler than anticipated. I&rsquo;ve always wanted to try <a href=https://www.packet.com/>packet.com</a>, since they have automated their deployment (it can be controlled via an API, thus allowing tools like Terraform to shine), they have a marketplace on which you can bid for machine&rsquo;s usage per hour (called <a href=https://www.packet.com/developers/docs/getting-started/deployment-options/spot-market/>Spot Market</a>, accessible via their API) and neat networking features (like <a href=https://www.packet.com/developers/docs/network/advanced/local-and-global-bgp/>BGP</a> - Border Gateway Protocol, which will need further).</p><p>We can choose from 3 deployment types: on-demand, reserved and spot. Let&rsquo;s try the spot instances since those can be really cheap.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-09_at_12.19.28.png alt=/Screenshot_2020-05-09_at_12.19.28.png></p><p>Once a spot market request was created, it will check for available machines that comply with your bid, and start provisioning them. For a max bid of $0.10 / h, we get a <a href=https://www.packet.com/cloud/servers/c1-small/>c1.small.x86</a> instance, with 4 physical cores running at 3.4Ghz (<a href=https://ark.intel.com/content/www/us/en/ark/products/75055/intel-xeon-processor-e3-1240-v3-8m-cache-3-40-ghz.html>Intel E3-1240 v3</a>), 32GB RAM, 2 x 120GB SSD and 2 Gigabit NICs.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-09_at_12.33.00.png alt=/Screenshot_2020-05-09_at_12.33.00.png></p><p>I&rsquo;ve updated the hostname for each of one and now we&rsquo;re ready to install Kubernetes.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-09_at_13.05.54.png alt=/Screenshot_2020-05-09_at_13.05.54.png></p><h3 id=kubernetes-on-bare-metal>Kubernetes on bare-metal</h3><p>There are tons of guides out there on how to install Kubernetes on bare metal, from installing all the components manually to using scripts or other tools. The most popular choices are <a href=https://github.com/kubernetes/kops>kops</a>, <a href=https://github.com/kubernetes/kubeadm>kubeadm</a> and <a href=https://github.com/kubernetes-sigs/kubespray>kubespray</a>. I went with kubespray since, for me, it was easier to understand and it was the path with the least resistance to follow since I have some ansible experience. <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/comparisons.md>Here</a> you can find a small comparison between kops, kubeadm, and kubespray.</p><p>Kubespray is easy to install and to use. We just need to clone the <a href=https://github.com/kubernetes-sigs/kubespray>repository</a> and install it using</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo pip3 install -r requirements.txt
</span></span></code></pre></div><p>We can also install it in a separate virtual environment if we have different versions of ansible running on your machine.</p><p>Next, we need to define an inventory of servers. It comes with pre-defined inventory examples. We can use Packet&rsquo;s API to list all your servers, but I decided to use a static one. Just copy the <code>sample</code> inventory into a separate one (I&rsquo;ve called it <code>rabbit</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd kubespray
</span></span><span style=display:flex><span>cp -R inventory/sample/ intentory/rabbit
</span></span></code></pre></div><p>Now add our servers in <code>inventory.ini</code></p><pre tabindex=0><code>[all]
rabbit-1.vtemian.com ansible_host=147.75.84.27 ansible_user=root ip=10.80.204.129 etcd_member_name=etcd1
rabbit-2.vtemian.com ansible_host=147.75.100.161 ansible_user=root ip=10.80.204.131 etcd_member_name=etcd2
rabbit-3.vtemian.com ansible_host=147.75.100.215 ansible_user=root ip=10.80.204.133 etcd_member_name=etcd3

[kube-master]
rabbit-1.vtemian.com

[etcd]
rabbit-1.vtemian.com

[kube-node]
rabbit-2.vtemian.com
rabbit-3.vtemian.com

[calico-rr]

[k8s-cluster:children]
kube-master
kube-node
calico-rr
</code></pre><p>Because when I was setting up my cluster, kubespray didn&rsquo;t fully supported Ubuntu 20.04, I had to update the tasks a little bit. I&rsquo;ve replaced <code>python-minimal</code> with <code>python2-minimal</code> and install Docker from Ubuntu 19.10 (Eoan) repositories.</p><p>Next, we just need to run ansible and let it do the magic.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook --become -i inventory/rabbit/inventory.ini cluster.yml
</span></span></code></pre></div><p>If everything worked as intended, we&rsquo;ll have a new cluster, up and running. In order to access it, we can grab the admin credentials, from the kube-master node.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>scp root@rabbit-1.vtemian.com:/etc/kubernetes/admin.conf .
</span></span></code></pre></div><p>Next, add those into our local kubectl config (usually located at <code>~/.kube/config</code>) and we&rsquo;ll be able to access the cluster, using <code>kubectl</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pod --all-namespaces -o wide
</span></span><span style=display:flex><span>NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE     IP              NODE                   NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>kube-system   calico-kube-controllers-5679c8548f-rffvp       1/1     Running   <span style=color:#ae81ff>0</span>          2m46s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   calico-node-6wt2p                              1/1     Running   <span style=color:#ae81ff>1</span>          3m12s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   calico-node-98cnq                              1/1     Running   <span style=color:#ae81ff>1</span>          3m12s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   calico-node-kh9k8                              1/1     Running   <span style=color:#ae81ff>1</span>          3m12s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   coredns-76798d84dd-75tz6                       1/1     Running   <span style=color:#ae81ff>0</span>          2m21s   10.233.82.1     rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   coredns-76798d84dd-bqt66                       1/1     Running   <span style=color:#ae81ff>0</span>          2m17s   10.233.80.1     rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   dns-autoscaler-85f898cd5c-nskgf                1/1     Running   <span style=color:#ae81ff>0</span>          2m18s   10.233.82.2     rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-apiserver-rabbit-1.vtemian.com            1/1     Running   <span style=color:#ae81ff>0</span>          4m58s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-rabbit-1.vtemian.com   1/1     Running   <span style=color:#ae81ff>0</span>          4m58s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-proxy-4ktbs                               1/1     Running   <span style=color:#ae81ff>0</span>          3m34s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-proxy-kd6n2                               1/1     Running   <span style=color:#ae81ff>0</span>          3m34s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-proxy-ts8nw                               1/1     Running   <span style=color:#ae81ff>0</span>          3m34s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kube-scheduler-rabbit-1.vtemian.com            1/1     Running   <span style=color:#ae81ff>0</span>          4m58s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kubernetes-dashboard-77475cf576-7sdr6          1/1     Running   <span style=color:#ae81ff>0</span>          2m15s   10.233.83.2     rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   kubernetes-metrics-scraper-747b4fd5cd-k96pn    1/1     Running   <span style=color:#ae81ff>0</span>          2m15s   10.233.83.1     rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   nginx-proxy-rabbit-2.vtemian.com               1/1     Running   <span style=color:#ae81ff>0</span>          3m35s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   nginx-proxy-rabbit-3.vtemian.com               1/1     Running   <span style=color:#ae81ff>0</span>          3m36s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   nodelocaldns-9l6vf                             1/1     Running   <span style=color:#ae81ff>0</span>          2m17s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   nodelocaldns-blbcb                             1/1     Running   <span style=color:#ae81ff>0</span>          2m17s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   nodelocaldns-vrspt                             1/1     Running   <span style=color:#ae81ff>0</span>          2m17s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt; 
</span></span></code></pre></div><h3 id=metallb>MetalLB</h3><p>Going further, we should be able to install Knative. A big step in Knative&rsquo;s installation is the routing component. It supports multiple networking layers (Ambassador, Contour, Gloo, Istio, and Kourier). The only problem is that those layers need a load balancer that will be exposed to the Internet (an external <a href=https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/>LoadBalancer</a>). Kubernetes doesn&rsquo;t have native support for that. Basically, the current implementations are vendor-specific (AWS, GCP, Azure etc.) and because we&rsquo;re on bare-metal, we can&rsquo;t afford the luxury of using one of those.</p><p>Luckily, there&rsquo;s an implementation for bare-metal, called <a href=https://metallb.universe.tf/>MetalLB</a>. It can do that in two ways: at <a href=https://metallb.universe.tf/concepts/layer2/>layer 2</a> using ARP/NDP or by leveraging <a href=https://metallb.universe.tf/concepts/bgp/>BGP</a>. Because Packet has support for <a href=https://www.packet.com/developers/docs/network/advanced/local-and-global-bgp/>BGP</a> and they also provide a useful example on how to configure <a href=https://github.com/packet-labs/kubernetes-bgp>MetalLB</a>, we&rsquo;ll give them a try.</p><p>The instructions from Packet&rsquo;s BGP - Kubernetes <a href=https://github.com/packet-labs/kubernetes-bgp#calico>integration</a> are well documented and easy to follow. We just need to be careful with the IPPools. Before defining them, I&rsquo;ve configured 2 sets of elastic IPs:</p><p>A global IP <code>147.75.40.130/32</code> and a Public IPv4 <code>147.75.80.160/30</code>.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-09_at_16.27.30.png alt=/Screenshot_2020-05-09_at_16.27.30.png></p><p><a href=https://www.packet.com/developers/docs/network/basic/elastic-ips/>For security reason</a>s, you&rsquo;ll need to manually configure the IPs, for each server. Its fairly easy to do it and well documented. For each server, attach them an IP from the <code>Network</code> section:</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-09_at_16.36.03.png alt=/Screenshot_2020-05-09_at_16.36.03.png></p><p>And that, on each server manually (or via ansible), an example for Ubuntu/Debian, if you just want to play around with, run:</p><pre tabindex=0><code>sudo ip addr add &lt;elastic-ip&gt; dev lo
</code></pre><p>To make it permanent, we&rsquo;ll need to edit <code>/etc/network/interfaces</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>auto lo:0
</span></span><span style=display:flex><span>iface lo:0 inet static
</span></span><span style=display:flex><span>    address &lt;elastic-ip&gt;
</span></span><span style=display:flex><span>    netmask 255.255.255.255
</span></span></code></pre></div><p>Continuing with the IPPools configuration, for <code>metallb-ewr1-public</code> will have <code>147.75.80.160/30</code>, for <code>metallb-global-ips</code> will have <code>147.75.40.130/32</code> and for <code>metallb-private</code> will have our private nodes subnet, which in the current case should be <code>10.80.204.128/29</code>. You can play around with the node&rsquo;s private ips and a CIDR-IP conversion <a href=https://www.ipaddressguide.com/cidr>tool</a>.</p><p>For each calico peer config (worker), we&rsquo;ll put node&rsquo;s private IP.</p><p>Next, we&rsquo;ll install the latest metalLB manifest:</p><pre tabindex=0><code>kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.8.1/manifests/metallb.yaml
</code></pre><p>Followed by the metalLB&rsquo;s config map, in <code>metallb-system</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>metallb-system</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    peers:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - peer-address: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      peer-asn: 65000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      my-asn: 65480
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    address-pools:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - name: ewr1-public
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      protocol: bgp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      addresses:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - 147.75.80.160/30
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - name: ewr1-private
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      protocol: bgp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      addresses:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - 10.80.204.128/29
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - name: global-ip
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      protocol: bgp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      addresses:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - 147.75.40.130/32</span>    
</span></span></code></pre></div><p>We can check if everything is configured correctly, by running <code>calicoctl node status</code> in our master node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@rabbit-1:~# calicoctl node status
</span></span><span style=display:flex><span>Calico process is running.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPv4 BGP status
</span></span><span style=display:flex><span>+----------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |
</span></span><span style=display:flex><span>+----------------+-------------------+-------+----------+-------------+
</span></span><span style=display:flex><span>| 147.75.100.215 | node-to-node mesh | up    | 13:46:38 | Established |
</span></span><span style=display:flex><span>| 127.0.0.1      | global            | up    | 13:51:44 | Established |
</span></span><span style=display:flex><span>| 147.75.100.161 | node-to-node mesh | up    | 13:47:27 | Established |
</span></span><span style=display:flex><span>+----------------+-------------------+-------+----------+-------------+
</span></span></code></pre></div><p>And other kubectl commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pod -n kube-system -o wide | grep calico-node
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>calico-node-479fz                              1/1     Running   <span style=color:#ae81ff>0</span>          8m25s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>calico-node-846gr                              1/1     Running   <span style=color:#ae81ff>0</span>          7m18s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>calico-node-tpnjc                              1/1     Running   <span style=color:#ae81ff>0</span>          8m8s    10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pod -n metallb-system -o wide
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                          READY   STATUS    RESTARTS   AGE    IP              NODE                   NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>controller-6bcfdfd677-nxnw8   1/1     Running   <span style=color:#ae81ff>0</span>          5m4s   10.233.65.193   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>speaker-d6kks                 1/1     Running   <span style=color:#ae81ff>0</span>          5m4s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>speaker-kk85w                 1/1     Running   <span style=color:#ae81ff>0</span>          5m4s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>speaker-p4lc7                 1/1     Running   <span style=color:#ae81ff>0</span>          5m4s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><h3 id=istio>Istio</h3><p>Now that we have the MetalLB up and running we can continue with the last routing component. Between all those networking components that Knative supports, I&rsquo;ve chosen <a href=https://istio.io/>Istio</a>, because it is the only one compatible with the Knative operator (which will be mention further).</p><p>We just need to follow the instructions from the main install <a href=https://knative.dev/development/install/installing-istio/#downloading-istio-and-installing-crds>page</a> and if everything worked, we&rsquo;ll have a load balancer, with an external IP.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get service --all-namespaces
</span></span><span style=display:flex><span>NAMESPACE      NAME                        TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                                                                                                                                      AGE
</span></span><span style=display:flex><span>default        kubernetes                  ClusterIP      10.233.0.1      &lt;none&gt;          443/TCP                                                                                                                                      101m
</span></span><span style=display:flex><span>istio-system   istio-ingressgateway        LoadBalancer   10.233.24.125   147.75.80.160   15020:30935/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31350/TCP,15030:31699/TCP,15031:32315/TCP,15032:31519/TCP,15443:32542/TCP   55s
</span></span><span style=display:flex><span>istio-system   istio-pilot                 ClusterIP      10.233.48.55    &lt;none&gt;          15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       55s
</span></span><span style=display:flex><span>kube-system    coredns                     ClusterIP      10.233.0.3      &lt;none&gt;          53/UDP,53/TCP,9153/TCP                                                                                                                       98m
</span></span><span style=display:flex><span>kube-system    dashboard-metrics-scraper   ClusterIP      10.233.61.223   &lt;none&gt;          8000/TCP                                                                                                                                     97m
</span></span><span style=display:flex><span>kube-system    kubernetes-dashboard        ClusterIP      10.233.16.174   &lt;none&gt;          443/TCP                                                                                                                                      97m
</span></span></code></pre></div><h3 id=knative>Knative</h3><p>We&rsquo;re ready to install Knative. I found that the easier path is to install the common operator that will further install all the components. I&rsquo;ve tried installing each component manually, but it can get really tricky.</p><p>For now, we need to install the operator in the <code>default</code> namespace, since it will look for a ConfigMap called <code>config-loggin</code> in the <code>default</code> namespace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubens default
</span></span><span style=display:flex><span>╰─&gt;$ kubectl apply -f https://github.com/knative-sandbox/operator/releases/download/v0.14.1/operator.yaml
</span></span></code></pre></div><p>Once the CRDs are installed and the operator&rsquo;s pods are running</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pods
</span></span><span style=display:flex><span>NAME                                         READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>knative-eventing-operator-5847fcc5d5-d4cb4   1/1     Running   <span style=color:#ae81ff>0</span>          53s
</span></span><span style=display:flex><span>knative-serving-operator-587dcd9f85-zlx7v    1/1     Running   <span style=color:#ae81ff>0</span>          53s
</span></span></code></pre></div><p>We can create the <code>KnativeServing</code> and <code>KnativeEventing</code> resources:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ cat <span style=color:#e6db74>&lt;&lt;-EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: operator.knative.dev/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: KnativeServing
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: ks
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>╰─&gt;$ cat <span style=color:#e6db74>&lt;&lt;-EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74> name: knative-eventing
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: operator.knative.dev/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: KnativeEventing
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: ke
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: knative-eventing
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>New pods and resources are being installed in the <code>default</code> and <code>knative-eventing</code> namespaces</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pods --all-namespaces -o wide
</span></span><span style=display:flex><span>NAMESPACE          NAME                                           READY   STATUS      RESTARTS   AGE     IP              NODE                   NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>default            activator-65fc4d666-7bwst                      1/1     Running     <span style=color:#ae81ff>0</span>          39s     10.233.125.68   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            autoscaler-74b4bb97bd-ghj59                    1/1     Running     <span style=color:#ae81ff>0</span>          38s     10.233.65.195   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            autoscaler-hpa-594f68d5c4-8qtg4                1/1     Running     <span style=color:#ae81ff>0</span>          30s     10.233.65.198   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            controller-6b6978c965-rqb2z                    1/1     Running     <span style=color:#ae81ff>0</span>          37s     10.233.65.196   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            istio-webhook-856d84fbf9-wvpph                 1/1     Running     <span style=color:#ae81ff>0</span>          26s     10.233.125.71   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            knative-eventing-operator-5847fcc5d5-d4cb4     1/1     Running     <span style=color:#ae81ff>0</span>          3m18s   10.233.125.67   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            knative-serving-operator-587dcd9f85-zlx7v      1/1     Running     <span style=color:#ae81ff>0</span>          3m18s   10.233.125.66   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            networking-istio-6845f7cf59-bsqc2              1/1     Running     <span style=color:#ae81ff>0</span>          26s     10.233.125.69   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>default            webhook-577576647-wrw56                        1/1     Running     <span style=color:#ae81ff>0</span>          36s     10.233.65.197   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>istio-system       istio-ingressgateway-75694cd848-l6zfh          1/1     Running     <span style=color:#ae81ff>0</span>          64m     10.233.125.65   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>istio-system       istio-pilot-576d858689-zxv76                   1/1     Running     <span style=color:#ae81ff>0</span>          64m     10.233.65.194   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   broker-controller-854447b8d7-vdmdz             1/1     Running     <span style=color:#ae81ff>0</span>          18s     10.233.65.200   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   broker-filter-b54b58854-w9jvw                  1/1     Running     <span style=color:#ae81ff>0</span>          17s     10.233.125.72   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   broker-ingress-75b6b8df8d-mlppj                1/1     Running     <span style=color:#ae81ff>0</span>          16s     10.233.65.201   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   eventing-controller-694594fdd7-gj2br           1/1     Running     <span style=color:#ae81ff>0</span>          26s     10.233.125.70   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   eventing-webhook-6c6b675b6f-t4ntx              1/1     Running     <span style=color:#ae81ff>0</span>          26s     10.233.65.199   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   imc-controller-7bb9bd7c6d-q2tsz                1/1     Running     <span style=color:#ae81ff>0</span>          10s     10.233.125.73   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   imc-dispatcher-6cc5c74c7f-kdj7v                1/1     Running     <span style=color:#ae81ff>0</span>          10s     10.233.125.74   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   mt-broker-controller-75ddc75d57-rg6jd          1/1     Running     <span style=color:#ae81ff>0</span>          15s     10.233.65.202   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>knative-eventing   v0.14.0-upgrade-4sv89                          0/1     Completed   <span style=color:#ae81ff>0</span>          9s      10.233.65.203   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Before we actually test it, let&rsquo;s configure the DNS component. We&rsquo;ll want to have a unique URL generated each time a new deployment is created. Knative can do that using <a href=http://xip.io>xip.io</a> and we just need to create a job (we&rsquo;ll need to install it in the <code>default</code> namespace):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl apply --filename https://storage.googleapis.com/knative-nightly/serving/latest/serving-default-domain.yaml
</span></span></code></pre></div><h3 id=first-knative-service>First Knative service</h3><p>Within our initial application, I&rsquo;ve created a simple <a href=https://github.com/vtemian/simple-django-app/tree/docker>Dockerfile</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FROM python:3.7-slim
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WORKDIR /app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY requirements.txt ./
</span></span><span style=display:flex><span>RUN pip install -r requirements.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY app ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD exec gunicorn app.wsgi --bind :$PORT --workers <span style=color:#ae81ff>1</span> --threads <span style=color:#ae81ff>8</span> --timeout <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>And published the image, publicly, under <code>vtemian/simple-django-app</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ docker push vtemian/simple-django-app
</span></span><span style=display:flex><span>The push refers to repository <span style=color:#f92672>[</span>docker.io/vtemian/simple-django-app<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>7aa16540cfca: Pushed
</span></span><span style=display:flex><span>2e02cc50aabc: Pushed
</span></span><span style=display:flex><span>768f0318f857: Pushed
</span></span><span style=display:flex><span>663045c38f65: Pushed
</span></span><span style=display:flex><span>715414420313: Mounted from vtemian/helloworld-python
</span></span><span style=display:flex><span>dba4fa00b93a: Mounted from vtemian/helloworld-python
</span></span><span style=display:flex><span>9f690547ed37: Mounted from vtemian/helloworld-python
</span></span><span style=display:flex><span>6376837eded8: Mounted from vtemian/helloworld-python
</span></span><span style=display:flex><span>c2adabaecedb: Mounted from vtemian/helloworld-python
</span></span><span style=display:flex><span>latest: digest: sha256:78799d85949e31728c70ef3dbf3a492d932fc94c140cf1047d948c89141f55ab size: <span style=color:#ae81ff>2205</span>
</span></span></code></pre></div><p>To publish it on our Knative installation, we just need to define a service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>serving.knative.dev/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>simple-django-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/vtemian/simple-django-app</span>
</span></span></code></pre></div><p>Aaaaaand <code>kubectl get ksvc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get ksvc
</span></span><span style=display:flex><span>NAME                URL                                                     LATESTCREATED             LATESTREADY   READY     REASON
</span></span><span style=display:flex><span>simple-django-app   http://simple-django-app.default.147.75.80.160.xip.io   simple-django-app-hc2qv                 Unknown   RevisionMissing
</span></span></code></pre></div><p>Going to the generated URL</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-09_at_18.28.18.png alt=/Screenshot_2020-05-09_at_18.28.18.png></p><p>Now this&mldr;this is pretty damn cool! There&rsquo;s no database and we still need to build our containers, but it looks pretty damn cool!</p><h3 id=elasticsearch-and-kibana>ElasticSearch and Kibana</h3><p>Before we move further to test it more, let&rsquo;s configure some observability tools, like ElasticSearch + Kibana for logs and Prometheus + Grafana for metrics.</p><p>Let&rsquo;s start with the metrics component. We&rsquo;ll follow the <a href=https://knative.dev/development/serving/installing-logging-metrics-traces/>guide</a> and we&rsquo;ll just need to edit the <code>config-observability</code> config map. It already provides us with an config example, we&rsquo;ll be using it. Just unindent the exemple, for now. Next, we&rsquo;ll need to create the <code>knative-monitoring</code> namespace, and apply the manifests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl apply --filename https://storage.googleapis.com/knative-nightly/serving/latest/monitoring-metrics-prometheus.yaml
</span></span></code></pre></div><p>The pods should be up and running in the <code>knative-monitoring</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pod -n knative-monitoring -o wide
</span></span><span style=display:flex><span>NAME                                 READY   STATUS    RESTARTS   AGE    IP              NODE                   NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>grafana-c9c94bdff-5f77v              1/1     Running   <span style=color:#ae81ff>0</span>          2m3s   10.233.65.210   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-state-metrics-b6bcff8f4-tvp46   1/1     Running   <span style=color:#ae81ff>0</span>          2m7s   10.233.65.209   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>node-exporter-9wkpn                  2/2     Running   <span style=color:#ae81ff>0</span>          2m4s   10.80.204.131   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>node-exporter-lfjss                  2/2     Running   <span style=color:#ae81ff>0</span>          2m4s   10.80.204.129   rabbit-1.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>node-exporter-zjl7b                  2/2     Running   <span style=color:#ae81ff>0</span>          2m4s   10.80.204.133   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>prometheus-system-0                  1/1     Running   <span style=color:#ae81ff>0</span>          2m1s   10.233.65.211   rabbit-3.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>prometheus-system-1                  1/1     Running   <span style=color:#ae81ff>0</span>          2m1s   10.233.125.75   rabbit-2.vtemian.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>By default, Grafana comes with some really nice dashboards and with Prometheus configured as a data source. The only problem is that the Prometheus configured, is not the currently running service. We&rsquo;ll need to get all currently running services and check Prometheus service name, which in this case is <code>prometheus-system-discovery</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl -n knative-monitoring get service
</span></span><span style=display:flex><span>NAME                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>             AGE
</span></span><span style=display:flex><span>kube-controller-manager       ClusterIP   None            &lt;none&gt;        10252/TCP           5m36s
</span></span><span style=display:flex><span>kube-state-metrics            ClusterIP   10.233.56.244   &lt;none&gt;        8080/TCP,8081/TCP   5m41s
</span></span><span style=display:flex><span>node-exporter                 ClusterIP   None            &lt;none&gt;        9100/TCP            5m38s
</span></span><span style=display:flex><span>prometheus-system-discovery   ClusterIP   None            &lt;none&gt;        9090/TCP            5m36s
</span></span></code></pre></div><p>We&rsquo;ll have to edit Grafana&rsquo;s config map and replace Prometheus&rsquo; URL with <code>[http://prometheus-system-discovery.knative-monitoring.svc:9090](http://prometheus-system-discovery.knative-monitoring.svc:9090/)</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl -n knative-monitoring edit cm grafana-datasources
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  prometheus.yaml: |
</span></span><span style=display:flex><span>    datasources:
</span></span><span style=display:flex><span>     - name: prometheus
</span></span><span style=display:flex><span>       type: prometheus
</span></span><span style=display:flex><span>       access: proxy
</span></span><span style=display:flex><span>       org_id: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       url: http://prometheus-system-discovery.knative-monitoring.svc:9090
</span></span><span style=display:flex><span>       version: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       editable: false
</span></span></code></pre></div><p>Delete the current running Grafana pod</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl delete po -n knative-monitoring --selector<span style=color:#f92672>=</span>app<span style=color:#f92672>=</span>grafana
</span></span><span style=display:flex><span>pod <span style=color:#e6db74>&#34;grafana-c9c94bdff-rkvrg&#34;</span> deleted
</span></span></code></pre></div><p>Wait until a new pod is started and you can port-forward it</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl port-forward --namespace knative-monitoring <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     <span style=color:#f92672>(</span>kubectl get pods --namespace knative-monitoring <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     --selector<span style=color:#f92672>=</span>app<span style=color:#f92672>=</span>grafana --output<span style=color:#f92672>=</span>jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.items..metadata.name}&#34;</span><span style=color:#f92672>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>Forwarding from 127.0.0.1:3000 -&gt; <span style=color:#ae81ff>3000</span>
</span></span></code></pre></div><p><img src=https://blog.vtemian.com/Screenshot_2020-05-10_at_13.29.25.png alt=/Screenshot_2020-05-10_at_13.29.25.png></p><p>All of those default dashboards are interesting, but I found the most useful the <code>Knative Serving - Revision HTTP Requests</code>, that describes current running applications.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-10_at_15.47.39.png alt=/Screenshot_2020-05-10_at_15.47.39.png></p><p>And the <code>Kubernetes Capacity Planning</code> that gives an overview over the entire cluster.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-10_at_15.48.07.png alt=/Screenshot_2020-05-10_at_15.48.07.png></p><p>Moving to logs, we&rsquo;ll need to configure ElasticSearch and Kibana. We&rsquo;ll need to edit the <code>config-observability</code> ConfigMap and set the <code>logging.request-log-template</code> to</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl edit cm config-observability
</span></span><span style=display:flex><span>logging.request-log-template: <span style=color:#e6db74>&#39;{&#34;httpRequest&#34;: {&#34;requestMethod&#34;: &#34;{{.Request.Method}}&#34;, &#34;requestUrl&#34;: &#34;{{js .Request.RequestURI}}&#34;, &#34;requestSize&#34;: &#34;{{.Request.ContentLength}}&#34;, &#34;status&#34;: {{.Response.Code}}, &#34;responseSize&#34;: &#34;{{.Response.Size}}&#34;, &#34;userAgent&#34;: &#34;{{js .Request.UserAgent}}&#34;, &#34;remoteIp&#34;: &#34;{{js .Request.RemoteAddr}}&#34;, &#34;serverIp&#34;: &#34;{{.Revision.PodIP}}&#34;, &#34;referer&#34;: &#34;{{js .Request.Referer}}&#34;, &#34;latency&#34;: &#34;{{.Response.Latency}}s&#34;, &#34;protocol&#34;: &#34;{{.Request.Proto}}&#34;}, &#34;traceId&#34;: &#34;{{index .Request.Header &#34;X-B3-Traceid&#34;}}&#34;}&#39;</span>
</span></span></code></pre></div><p>Apply the manifest</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl apply --filename https://storage.googleapis.com/knative-nightly/serving/latest/monitoring-logs-elasticsearch.yaml
</span></span></code></pre></div><p>We&rsquo;ll set <code>[beta.kubernetes.io/fluentd-ds-ready="true"](http://beta.kubernetes.io/fluentd-ds-ready=%22true%22)</code> label for our nodes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl label nodes --all beta.kubernetes.io/fluentd-ds-ready<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>node/rabbit-1.vtemian.com labeled
</span></span><span style=display:flex><span>node/rabbit-2.vtemian.com labeled
</span></span><span style=display:flex><span>node/rabbit-3.vtemian.com labeled
</span></span></code></pre></div><p>And check if the fluentd daemon set is running on our nodes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get daemonset fluentd-ds --namespace knative-monitoring
</span></span><span style=display:flex><span>NAME         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                              AGE
</span></span><span style=display:flex><span>fluentd-ds   <span style=color:#ae81ff>2</span>         <span style=color:#ae81ff>2</span>         <span style=color:#ae81ff>2</span>       <span style=color:#ae81ff>2</span>            <span style=color:#ae81ff>2</span>           beta.kubernetes.io/fluentd-ds-ready<span style=color:#f92672>=</span>true   5m37s
</span></span></code></pre></div><p>In this point, on each node a Fluentd daemon is running, collecting logs and send them to ElasticSearch. Furthermore, we&rsquo;ll need to configure Kibana to access those logs.</p><p>We&rsquo;ll start the local proxy</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$kubectl proxy
</span></span></code></pre></div><p>And visit <a href=http://localhost:8001/api/v1/namespaces/knative-monitoring/services/kibana-logging/proxy/app/kibana>Kibana UI</a>. If the service doesn&rsquo;t start, you can create one with the following configuration</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kibana-logging</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>knative-monitoring</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kibana-logging</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubernetes.io/cluster-service</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubernetes.io/name</span>: <span style=color:#e6db74>&#34;Kibana&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5601</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>ui</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kibana-logging</span>
</span></span></code></pre></div><p>Create a new index and wait until is processed.</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-10_at_16.27.12.png alt=/Screenshot_2020-05-10_at_16.27.12.png></p><p>Set it as the default index</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-10_at_16.45.24.png alt=/Screenshot_2020-05-10_at_16.45.24.png></p><p>And the logs should flow</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-10_at_16.59.57.png alt=/Screenshot_2020-05-10_at_16.59.57.png></p><h3 id=autoscaling>Autoscaling</h3><p>Now that we can really see what is happening in the cluster, let&rsquo;s configure the autoscaling and 0 scaling. For that, we&rsquo;ll need to edit the <code>config-autoscaler</code> ConfigMap. All options are already described in the comments, and for testing purpose, this is the configuration I&rsquo;m using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>activator-capacity</span>: <span style=color:#e6db74>&#34;100.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>container-concurrency-target-default</span>: <span style=color:#e6db74>&#34;100&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>container-concurrency-target-percentage</span>: <span style=color:#e6db74>&#34;70&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enable-graceful-scaledown</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enable-scale-to-zero</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>max-scale-down-rate</span>: <span style=color:#e6db74>&#34;2.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>max-scale-up-rate</span>: <span style=color:#e6db74>&#34;1000.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>panic-threshold-percentage</span>: <span style=color:#e6db74>&#34;20.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>panic-window-percentage</span>: <span style=color:#e6db74>&#34;5.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pod-autoscaler-class</span>: <span style=color:#ae81ff>kpa.autoscaling.knative.dev</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>requests-per-second-target-default</span>: <span style=color:#e6db74>&#34;20&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>scale-to-zero-grace-period</span>: <span style=color:#ae81ff>30s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stable-window</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>target-burst-capacity</span>: <span style=color:#e6db74>&#34;10&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tick-interval</span>: <span style=color:#ae81ff>2s </span>
</span></span></code></pre></div><p>All those options are explained in the <a href=https://knative.dev/docs/serving/configuring-autoscaling/>docs</a>, but maybe what we&rsquo;re most interested are the 0 scaling</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># specifies the time an inactive revision is left running before it is scaled to zero (min: 6s).</span>
</span></span><span style=display:flex><span><span style=color:#f92672>scale-to-zero-grace-period</span>: <span style=color:#ae81ff>30s</span>
</span></span><span style=display:flex><span><span style=color:#75715e># enables scale to zero</span>
</span></span><span style=display:flex><span><span style=color:#f92672>enable-scale-to-zero</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>And the autoscaling trasholds</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># defines how many concurrent requests are wanted at a given time (soft limit) and is the recommended configuration for autoscaling.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>container-concurrency-target-default</span>: <span style=color:#e6db74>&#34;100&#34;</span>
</span></span></code></pre></div><p>Those are the configuration applied for each revision, but you can control independently, using annotations. Let&rsquo;s configure the Horizontal Pod Autoscaler to follow the CPU metric and scale if the current consumed CPU is 30% of the limit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>serving.knative.dev/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>simple-django-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>autoscaling.knative.dev/metric</span>: <span style=color:#ae81ff>cpu</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>autoscaling.knative.dev/target</span>: <span style=color:#e6db74>&#34;70&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>autoscaling.knative.dev/class</span>: <span style=color:#ae81ff>hpa.autoscaling.knative.dev</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/vtemian/simple-django-app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span></code></pre></div><p>Let&rsquo;s start a curl in background</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ watch -n 0.1 curl -SI http://simple-django-app.default.147.75.80.160.xip.io/polls/
</span></span></code></pre></div><p>And we have 2 running pods</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po -l serving.knative.dev/service<span style=color:#f92672>=</span>simple-django-app
</span></span><span style=display:flex><span>NAME                                                  READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>simple-django-app-g9zf5-deployment-5b76fdf7fc-mtlwt   2/2     Running   <span style=color:#ae81ff>0</span>          3m25s
</span></span><span style=display:flex><span>simple-django-app-mg96q-deployment-7db5bb6b9c-29ffw   2/2     Running   <span style=color:#ae81ff>0</span>          4m18s
</span></span></code></pre></div><p>Let&rsquo;s go further and start a <a href=https://locust.io/>Locust</a> test. We&rsquo;ll follow the instructions from <a href=https://github.com/zalando-incubator/docker-locust>zalando-incubator</a> and start for replicas that will hit our service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>_________________________________________________________________________________
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                         L O C A L - D E P L O Y M E N T
</span></span><span style=display:flex><span>_________________________________________________________________________________
</span></span><span style=display:flex><span>Target url: http://simple-django-app.default.147.75.80.160.xip.io/polls
</span></span><span style=display:flex><span>Where load test script is stored <span style=color:#f92672>(</span>e.g. https://raw.githubusercontent.com/zalando-incubator/docker-locust/master/example/simple.py<span style=color:#f92672>)</span>: https://raw.githubusercontent.com/zalando-incubator/docker-locust/master/example/simple.py
</span></span><span style=display:flex><span>Number of slave<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>Run type <span style=color:#f92672>[</span>automatic/manual<span style=color:#f92672>]</span>: manual
</span></span><span style=display:flex><span>----------------------------------------------
</span></span><span style=display:flex><span>                   VARIABLES
</span></span><span style=display:flex><span>----------------------------------------------
</span></span><span style=display:flex><span>TARGET_URL: http://simple-django-app.default.147.75.80.160.xip.io/polls
</span></span><span style=display:flex><span>LOCUST_FILE: https://raw.githubusercontent.com/zalando-incubator/docker-locust/master/example/simple.py
</span></span><span style=display:flex><span>SLAVES NUMBER: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>RUN_TYPE: manual <span style=color:#f92672>||</span> automatic<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>NUMBER OF USERS:
</span></span><span style=display:flex><span>HATCH_RATE:
</span></span><span style=display:flex><span>DURATION <span style=color:#f92672>[</span>in seconds<span style=color:#f92672>]</span>:
</span></span><span style=display:flex><span>COMPOSE: false
</span></span><span style=display:flex><span>SEND_ANONYMOUS_USAGE_INFO: true
</span></span><span style=display:flex><span>----------------------------------------------
</span></span></code></pre></div><p>And the results are pretty cool</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po -l serving.knative.dev/service<span style=color:#f92672>=</span>simple-django-app
</span></span><span style=display:flex><span>NAME                                                  READY   STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-249rj   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-2c6m9   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-2m6kk   2/2     Running     <span style=color:#ae81ff>0</span>          86s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-2mm7t   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-2q7f8   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-5xcxf   2/2     Running     <span style=color:#ae81ff>0</span>          71s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-6jxfw   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-77v6w   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-8qk5s   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-9n4h6   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-b466k   2/2     Running     <span style=color:#ae81ff>0</span>          7m57s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-b8qbf   2/2     Running     <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-bkt66   2/2     Running     <span style=color:#ae81ff>0</span>          71s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-bxbzf   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-d5xt5   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-jrchv   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-mtrvh   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-mzz7g   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-p7wvx   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-pbmzb   2/2     Running     <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-pzb92   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-pzkrr   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-qhjxq   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-rc2xx   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-s7lzm   2/2     Running     <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-sdpmf   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-ss66c   2/2     Running     <span style=color:#ae81ff>0</span>          6m27s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-ssrzg   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-t424m   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-tjlsz   2/2     Running     <span style=color:#ae81ff>0</span>          71s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-tzcjw   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-w2tsp   2/2     Running     <span style=color:#ae81ff>0</span>          71s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-x9626   2/2     Running     <span style=color:#ae81ff>0</span>          41s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-xm5pk   2/2     Running     <span style=color:#ae81ff>0</span>          86s
</span></span><span style=display:flex><span>simple-django-app-ns6fm-deployment-85cff985d5-xv9sw   2/2     Running     <span style=color:#ae81ff>0</span>          56s
</span></span></code></pre></div><p>Requests leaving the local machine</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-11_at_19.23.16.png alt=/Screenshot_2020-05-11_at_19.23.16.png></p><p>Requests for this current revision</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-11_at_19.28.30.png alt=/Screenshot_2020-05-11_at_19.28.30.png></p><p>Resource consumption</p><p><img src=https://blog.vtemian.com/Screenshot_2020-05-11_at_19.25.23.png alt=/Screenshot_2020-05-11_at_19.25.23.png></p><p>For now, we have a running Kubernetes cluster, on bare-metal (on top of Packet), with 3 nodes, a running Knative installation that serves and scales Docker images.</p><h3 id=mysql>Mysql</h3><p>Finally, let&rsquo;s add some state to this setup. At <a href=https://www.presslabs.com/>Presslabs</a>, the company I&rsquo;m currently working for, we&rsquo;ve built an operator for M<a href=https://github.com/presslabs/mysql-operator>y</a>SQL. It takes care of replication, backups, and other tedious operations. The installation and its configuration are fairly straight forward, but first, we need to configure some persistent volumes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>rabbit-1.vtemian.com</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>capacity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>11Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostPath</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/mnt/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodeAffinity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>required</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodeSelectorTerms</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>matchExpressions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>kubernetes.io/hostname</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>In</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>rabbit-1.vtemian.com</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>persistentVolumeReclaimPolicy</span>: <span style=color:#ae81ff>Retain</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>standard</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeMode</span>: <span style=color:#ae81ff>Filesystem</span>
</span></span></code></pre></div><p>Let&rsquo;s create one for each node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pv
</span></span><span style=display:flex><span>NAME                   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                           STORAGECLASS   REASON   AGE
</span></span><span style=display:flex><span>rabbit-1.vtemian.com   11Gi       RWO            Retain           Available                                   standard                2m58s
</span></span><span style=display:flex><span>rabbit-2.vtemian.com   11Gi       RWO            Retain           Bound       default/data-mysql-operator-0   standard                3m9s
</span></span><span style=display:flex><span>rabbit-3.vtemian.com   11Gi       RWO            Retain           Available                                   standard                3m19s
</span></span></code></pre></div><p>We now can continue with mysql-operator:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ helm repo add presslabs https://presslabs.github.io/charts
</span></span><span style=display:flex><span>╰─&gt;$ helm install presslabs/mysql-operator --name mysql-operator --set orchestrator.persistence.storageClass<span style=color:#f92672>=</span>standard
</span></span></code></pre></div><p>Furthermore, we&rsquo;ll need a secret with the credentials we want for our mysql cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>type</span>: <span style=color:#ae81ff>Opaque</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ROOT_PASSWORD</span>: <span style=color:#ae81ff>bXlwYXNz</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DATABASE</span>: <span style=color:#ae81ff>cmFiYml0Cg==</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>USER</span>: <span style=color:#ae81ff>cmFiYml0Cg==</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>PASSWORD</span>: <span style=color:#ae81ff>bXlwYXNz</span>
</span></span></code></pre></div><p>And create the cluster with 2 replicas</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>mysql.presslabs.org/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>MysqlCluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>my-secret</span>
</span></span></code></pre></div><p>Now we have our 2 replicas:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po -l app.kubernetes.io/name<span style=color:#f92672>=</span>mysql
</span></span><span style=display:flex><span>NAME                 READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>my-cluster-mysql-0   4/4     Running   <span style=color:#ae81ff>0</span>          3m11s
</span></span><span style=display:flex><span>my-cluster-mysql-1   4/4     Running   <span style=color:#ae81ff>0</span>          4m37s
</span></span></code></pre></div><p>And a service on which we can connect:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get service -l app.kubernetes.io/name<span style=color:#f92672>=</span>mysql
</span></span><span style=display:flex><span>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>             AGE
</span></span><span style=display:flex><span>my-cluster-mysql          ClusterIP   10.233.50.17    &lt;none&gt;        3306/TCP            10m
</span></span><span style=display:flex><span>my-cluster-mysql-master   ClusterIP   10.233.29.255   &lt;none&gt;        3306/TCP            10m
</span></span></code></pre></div><p>At this point, the serving component is up and running and tested with a dummy application. Let&rsquo;s move further with the building component.</p><h2 id=cicd>CI/CD</h2><h3 id=tekton>Tekton</h3><p>Knative used to have a build <a href=https://github.com/knative/build/>component</a>, which now is <a href=https://github.com/knative/build/issues/614>deprecated</a> in favour of <a href=https://tekton.dev/>Tekton</a>. There are some nice guides on how to configure Tekton and integrate it with Knative, but first, let&rsquo;s install it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
</span></span></code></pre></div><p>Finally, we just need to edit the <code>config-artifact-pvc</code> ConfigMap, in order to allow Tekton to save artifacts in a PVC.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>size</span>: <span style=color:#ae81ff>5Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>default</span>
</span></span></code></pre></div><p>Taking a look at Tekton pod&rsquo;s we can see that it&rsquo;s running properly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po -n tekton-pipelines
</span></span><span style=display:flex><span>NAME                                           READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>tekton-pipelines-controller-5c44bcfc44-gfhdx   1/1     Running   <span style=color:#ae81ff>0</span>          85m
</span></span><span style=display:flex><span>tekton-pipelines-webhook-7bd568f6c6-vll6v      1/1     Running   <span style=color:#ae81ff>0</span>          85m
</span></span></code></pre></div><h3 id=how-does-tekton-work>How does Tekton work?</h3><p>Before setting up the pipeline, let&rsquo;s explore Tekton a little bit. Tekton leverages CRDs and allow us to describe pipelines by defining Kubernetes resources. I&rsquo;ll resume the information from <a href=https://www.alibabacloud.com/blog/first-knative-attempt-a-quick-guide-to-continuous-integration-and-continuous-delivery_595803>this guide</a> and their official <a href=https://tekton.dev/docs/pipelines/>docs</a>.</p><p><a href=https://tekton.dev/docs/pipelines/tasks/>Tasks</a> are a template for defining an actual working unit. It&rsquo;s like defining a function, with its parameters and behavior. It defines one or more steps and at each step, a container is executed. Example from <a href=https://github.com/knative-sample/tekton-knativehttps://github.com/knative-sample/tekton-knative/blob/master/tekton-cicd/tasks/deploy-using-kubectl.yaml>https://github.com/knative-sample/tekton-knative</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>deploy-using-kubectl</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToYamlFile</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The path to the yaml file to deploy within the git source</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Url of image repository</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Tag of the images to be used.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#34;latest&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>update-yaml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;sed&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;-i&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;-e&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;s;__IMAGE__;${inputs.params.imageUrl}:${inputs.params.imageTag};g&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;/workspace/git-source/${inputs.params.pathToYamlFile}&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>run-kubectl</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.cn-hangzhou.aliyuncs.com/knative-sample/kubectl:v0.5.0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;kubectl&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;apply&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;-f&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;/workspace/git-source/${inputs.params.pathToYamlFile}&#34;</span>
</span></span></code></pre></div><p>A <a href=https://tekton.dev/docs/pipelines/taskruns/>TaskRun</a> is a running instance of a Task. It executes all the steps of a task, in order, until all of them are completed. Example from <a href=https://github.com/knative-sample/tekton-knativehttps://github.com/knative-sample/tekton-knative/blob/master/tekton-cicd/tasks/deploy-using-kubectl.yaml>https://github.com/knative-sample/tekton-knative</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TaskRun</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-to-image</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>taskRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-to-image</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToContext</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.pathToContext}&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.imageUrl}&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.imageTag}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resource</span>: <span style=color:#ae81ff>git-source</span>
</span></span></code></pre></div><p>A <a href=https://tekton.dev/docs/pipelines/pipelines/>Pipeline</a> allows us to define multiple tasks. Using TaskRun we could run only one task. Each Task in a Pipeline executes as a Pod. Example from <a href=https://github.com/knative-sample/tekton-knativehttps://github.com/knative-sample/tekton-knative/blob/master/tekton-cicd/tasks/deploy-using-kubectl.yaml>https://github.com/knative-sample/tekton-knative</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pipeline</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>build-and-deploy-pipeline</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToContext</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The path to the build context, used by Kaniko - within the workspace</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default</span>: <span style=color:#ae81ff>src</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToYamlFile</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The path to the yaml file to deploy within the git source</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Url of image repository</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Tag to apply to the built image</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-to-image</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>taskRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-to-image</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToContext</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.pathToContext}&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.imageUrl}&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.imageTag}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>resource</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>deploy-to-cluster</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>taskRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>deploy-using-kubectl</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>runAfter</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>source-to-image</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToYamlFile</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>:  <span style=color:#e6db74>&#34;${params.pathToYamlFile}&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.imageUrl}&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;${params.imageTag}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>resource</span>: <span style=color:#ae81ff>git-source</span>
</span></span></code></pre></div><p>Similar to TaskRun, <a href=https://tekton.dev/docs/pipelines/pipelineruns/>PipelineRun</a> executes all the tasks defined in a Pipeline. Example from <a href=https://github.com/knative-sample/tekton-knativehttps://github.com/knative-sample/tekton-knative/blob/master/tekton-cicd/tasks/deploy-using-kubectl.yaml>https://github.com/knative-sample/tekton-knative</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PipelineRun</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>generateName</span>: <span style=color:#ae81ff>tekton-kn-sample-</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pipelineRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>build-and-deploy-pipeline</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>resourceRef</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-knative-git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToContext</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;src&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToYamlFile</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;knative/helloworld-go.yaml&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;registry.cn-hangzhou.aliyuncs.com/knative-sample/tekton-knative-helloworld&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>trigger</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>manual</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceAccount</span>: <span style=color:#ae81ff>pipeline-account</span>
</span></span></code></pre></div><p><a href=https://tekton.dev/docs/pipelines/resources/>PipelineResources</a> allows us to define objects that are used by tasks&rsquo; inputs and outputs. Example from <a href=https://github.com/knative-sample/tekton-knativehttps://github.com/knative-sample/tekton-knative/blob/master/tekton-cicd/tasks/deploy-using-kubectl.yaml>https://github.com/knative-sample/tekton-knative</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PipelineResource</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-knative-git</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>revision</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>url</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>https://github.com/knative-sample/tekton-knative</span>
</span></span></code></pre></div><h3 id=pipeline-setup>Pipeline setup</h3><p>Those are all the major components that we&rsquo;ll play with.</p><p>Let&rsquo;s create a new namespace called <code>ci</code> and install the above manifests, adapted for our needs. I&rsquo;ve commited the changes in the example <a href=https://github.com/vtemian/simple-django-app/tree/tekton>app</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po
</span></span><span style=display:flex><span>NAME                                                           READY   STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>tekton-simple-django-app-1-deploy-to-cluster-982xv-pod-kkmpw   0/3     Completed   <span style=color:#ae81ff>0</span>          3m18s
</span></span><span style=display:flex><span>tekton-simple-django-app-1-source-to-image-8c47t-pod-ccc44     0/3     Completed   <span style=color:#ae81ff>0</span>          3m44s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get pipelinerun
</span></span><span style=display:flex><span>NAME                         SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME
</span></span><span style=display:flex><span>tekton-simple-django-app-1   True        Succeeded   2m14s       95s
</span></span></code></pre></div><h3 id=github-webhook-trigger>Github webhook trigger</h3><p>Right now, we manually have to trigger the build by deleting and re-creating the <code>Pipelinerun</code> resource. Let&rsquo;s try to automate it, by configuring a Github webhook that will ping the building process each time a new commit is made.</p><p>The setup for that is not too complex, nor too simple. When a github hook arrives, it lands in an <code>[EventListener](https://tekton.dev/docs/triggers/eventlisteners/)</code> pod (that will need to be exposed to the Internet via Istio). From its payload, we&rsquo;ll need to extract relevant parameters, like commit information. For that, we&rsquo;ll be using <a href=https://tekton.dev/docs/triggers/triggerbindings/>TriggerBindings</a>. The parameters are then used by <a href=https://tekton.dev/docs/triggers/triggertemplates/>TriggerTemplate</a> to generate our pipeline run. The following configurations are inspired by <a href=https://medium.com/@nikhilthomas1/cloud-native-cicd-on-openshift-with-openshift-pipelines-tektoncd-pipelines-part-3-github-1db6dd8e8ca7>@nikhilthomas1</a>.</p><p><img src=https://blog.vtemian.com/Untitled%201.png alt=/Untitled%201.png></p><p>Let&rsquo;s create the a role, service account and the role binding for this process.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>triggers.tekton.dev</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>eventlisteners</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>triggerbindings</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>triggertemplates</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>pipelineresources</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>triggers.tekton.dev</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>pipelineruns</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>pipelineresources</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>create</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>configmaps</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>create</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>update</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>delete</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-sa</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-rolebinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-sa</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-role⏎</span>
</span></span></code></pre></div><p>TriggerTemplate is very basic. It describes some parameters that can be used, from the binding and it patches them together with PipelineRun and other resources:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>triggers.tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TriggerTemplate</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggertemplate</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitrevision</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The git revision</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>default</span>: <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitrepositoryurl</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The git repository url</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>namespace</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The namespace to create the resources</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitrepositoryname</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The name of the deployment to be created / patched</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resourcetemplates</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PipelineResource</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-repo-$(params.gitrepositoryname)-$(uid)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$(params.namespace)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>git</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>revision</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$(params.gitrevision)</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>url</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$(params.gitrepositoryurl)</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PipelineRun</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>teokton-build-$(params.gitrepositoryname)-$(uid)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$(params.namespace)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>pipelineRef</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>build-and-deploy-pipeline</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>pipeline-account</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>git-source</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resourceRef</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>source-repo-$(params.gitrepositoryname)-$(uid)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToContext</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToDockerFile</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>Dockerfile</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pathToYamlFile</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>knative.yaml</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageUrl</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>docker.io/vtemian/$(params.gitrepositoryname)</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>imageTag</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>latest</span>
</span></span></code></pre></div><p>Our TriggerBinding will also be pretty simple. Just a mapping from Github&rsquo;s payload to the parameters used in TriggerTemplate</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>triggers.tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TriggerBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-pipelinebinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitrevision</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$(body.head_commit.id)</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>namespace</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitrepositoryurl</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$(body.repository.url)</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitrepositoryname</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$(body.repository.name)</span>
</span></span></code></pre></div><p>Finally, we&rsquo;ll need the EventListener, with binds a TemplateTrigger with a TemplateBinding</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>triggers.tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>EventListener</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>el-tekton-listener</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>tekton-triggers-sa</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>triggers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>bindings</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-pipelinebinding</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggertemplate</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get service | grep tek
</span></span><span style=display:flex><span>el-tekton-listener                ClusterIP      10.233.47.3     &lt;none&gt;                                                 8080/TCP                             114m
</span></span></code></pre></div><p>Now that we have the service, we&rsquo;ll just need to expose it using Istio&rsquo;s primitives. Let&rsquo;s use Tekton&rsquo;s tools for that, using a separate service account:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>secrets</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>create</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>update</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>delete</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>tekton.dev</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>eventlisteners</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>create</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>update</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>delete</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>apiGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>extensions</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ingresses</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>verbs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>create</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>list</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>delete</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>update</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook⏎</span>
</span></span></code></pre></div><p>Following by the task itself:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The external domain for the EventListener</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ExternalDomain</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The name of the Service used in the VirtualService</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>description</span>: <span style=color:#ae81ff>The service port that the VirtualService is being created on</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ServicePort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>ce</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      set -ex
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      cat &lt;&lt; EOF | kubectl create -f -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        name: $(inputs.params.Service)-gateway
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        selector:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          istio: ingressgateway
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        servers:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - port:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            number: 80
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            name: http-$(inputs.params.Service)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          hosts:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - $(inputs.params.ExternalDomain)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        name: $(inputs.params.Service)-virtual-service
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      spec:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        hosts:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - $(inputs.params.ExternalDomain)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        gateways:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - $(inputs.params.Service)-gateway
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        http:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - route:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          - destination:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              host: $(inputs.params.Service)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              port:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                number: $(inputs.params.ServicePort)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      EOF</span>      
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sh</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>lachlanevenson/k8s-kubectl:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>create-istio-gateway-virtualservice</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>: {}
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>emptyDir</span>: {}
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>work</span>
</span></span></code></pre></div><p>And ending with it&rsquo;s initialisation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TaskRun</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ExternalDomain</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>simple-django-app-event-listner.default.147.75.80.160.xip.io</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>el-tekton-listener</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ServicePort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;8080&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>taskRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Task</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>create-istio-gateway-virtualservice</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>1h0m0s</span>
</span></span></code></pre></div><p>And let&rsquo;s check the result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get VirtualService
</span></span><span style=display:flex><span>NAME                                 GATEWAYS                                                          HOSTS                                                                                                                                                  AGE
</span></span><span style=display:flex><span>el-tekton-listener-virtual-service   <span style=color:#f92672>[</span>el-tekton-listener-gateway<span style=color:#f92672>]</span>                                      <span style=color:#f92672>[</span>simple-django-app-event-listner.default.147.75.80.160.xip.io<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Now that we have the tools up and running in our cluster, we can create the webhook. For that, we&rsquo;ll need a Github personal token, stored in a secret</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>webhook-secret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>stringData</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e>#https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line#creating-a-token</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>token</span>: <span style=color:#ae81ff>&lt;token&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>secret</span>: <span style=color:#ae81ff>random-string-data</span>
</span></span></code></pre></div><p>The task that will actually create the webhook</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>create-webhook</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>github-secret</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>secret</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>$(inputs.params.GitHubSecretName)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ExternalDomain</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The external domain for the EventListener e.g. `$(inputs.params.EventListenerName).&lt;PROXYIP&gt;.nip.io`&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubUser</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The GitHub user&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubRepo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The GitHub repo where the webhook will be created&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubOrg</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The GitHub organization where the webhook will be created&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubSecretName</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The Secret name for GitHub access token. This is always mounted and must exist&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubAccessTokenKey</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The GitHub access token key name&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubSecretStringKey</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The GitHub secret string key name&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubDomain</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;The GitHub domain. Override for GitHub Enterprise&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#34;github.com&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>WebhookEvents</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;List of events the webhook will send notifications for&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#39;[\&#34;push\&#34;,\&#34;pull_request\&#34;]&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>create-webhook</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>pstauffer/curl:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>github-secret</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/secret</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sh</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>ce</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      set -e
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      echo &#34;Create Webhook&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      if [ $(inputs.params.GitHubDomain) = &#34;github.com&#34; ];then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        curl -v -d &#34;{\&#34;name\&#34;: \&#34;web\&#34;,\&#34;active\&#34;: true,\&#34;events\&#34;: $(inputs.params.WebhookEvents),\&#34;config\&#34;: {\&#34;url\&#34;: \&#34;$(inputs.params.ExternalDomain)\&#34;,\&#34;content_type\&#34;: \&#34;json\&#34;,\&#34;insecure_ssl\&#34;: \&#34;1\&#34; ,\&#34;secret\&#34;: \&#34;$(cat /var/secret/$(inputs.params.GitHubSecretStringKey))\&#34;}}&#34; -X POST -u $(inputs.params.GitHubUser):$(cat /var/secret/$(inputs.params.GitHubAccessTokenKey)) -L https://api.github.com/repos/$(inputs.params.GitHubOrg)/$(inputs.params.GitHubRepo)/hooks
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        curl -d &#34;{\&#34;name\&#34;: \&#34;web\&#34;,\&#34;active\&#34;: true,\&#34;events\&#34;: $(inputs.params.WebhookEvents),\&#34;config\&#34;: {\&#34;url\&#34;: \&#34;$(inputs.params.ExternalDomain)/\&#34;,\&#34;content_type\&#34;: \&#34;json\&#34;,\&#34;insecure_ssl\&#34;: \&#34;1\&#34; ,\&#34;secret\&#34;: \&#34;$(cat /var/secret/$(inputs.params.GitHubSecretStringKey))\&#34;}}&#34; -X POST -u $(inputs.params.GitHubUser):$(cat /var/secret/$(inputs.params.GitHubAccessTokenKey)) -L https://$(inputs.params.GitHubDomain)/api/v3/repos/$(inputs.params.GitHubOrg)/$(inputs.params.GitHubRepo)/hooks
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      fi</span>      
</span></span></code></pre></div><p>And it&rsquo;s initialization</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>tekton.dev/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TaskRun</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>create-api-repo-webhook-run</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>taskRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>create-webhook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubOrg</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;vtemian&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubUser</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;vtemian&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubRepo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;simple-django-app&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubSecretName</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>webhook-secret</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubAccessTokenKey</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>token</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GitHubSecretStringKey</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>secret</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ExternalDomain</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>http://simple-django-app-event-listner.default.147.75.80.160.xip.io</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>1000s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>tekton-triggers-createwebhook</span>
</span></span></code></pre></div><p><img src=https://blog.vtemian.com/Screenshot_2020-05-16_at_20.23.20.png alt></p><p>Now, each time we push new changes, a new build is being trigger:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po | grep teo
</span></span><span style=display:flex><span>teokton-build-simple-django-app-2fcdr-source-to-image-v86-mwxhw   0/3     Error       <span style=color:#ae81ff>0</span>          71m
</span></span><span style=display:flex><span>teokton-build-simple-django-app-qlw5w-source-to-image-sz2-gpqdm   0/3     Error       <span style=color:#ae81ff>0</span>          73m
</span></span><span style=display:flex><span>teokton-build-simple-django-app-sl9zf-source-to-image-knl-tzxpk   1/3     Running     <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>teokton-build-simple-django-app-xh54x-deploy-to-cluster-b-5p7r4   0/3     Completed   <span style=color:#ae81ff>0</span>          66m
</span></span><span style=display:flex><span>teokton-build-simple-django-app-xh54x-source-to-image-wv5-9bsdt   0/3     Completed   <span style=color:#ae81ff>0</span>          66m
</span></span></code></pre></div><p>And the application is being deployed</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>╰─&gt;$ kubectl get po | grep simple
</span></span><span style=display:flex><span>simple-django-app-cjx8b-deployment-7cd5c5999d-vwjhv               2/2     Running     <span style=color:#ae81ff>0</span>          4h3m
</span></span><span style=display:flex><span>simple-django-app-d2n6n-deployment-77c664bf4f-pz6hg               2/2     Running     <span style=color:#ae81ff>0</span>          4h29m
</span></span><span style=display:flex><span>simple-django-app-hcmpl-deployment-7687b96b5f-pv2wz               2/2     Running     <span style=color:#ae81ff>0</span>          67m
</span></span></code></pre></div><h2 id=conclusions>Conclusions</h2><p>In the end, we&rsquo;ve managed to configure a bare-metal infrastructure, install Knative and have a CI/CD that builds and deploys
new versions of our application, on git push. It&rsquo;s a little bit of a hassle and we left behind some details regarding
revisions, <a href=https://knative.dev/development/serving/using-subroutes/>routing</a> and
<a href=https://knative.dev/development/serving/samples/blue-green-deployment/>blue-green deployments</a>.</p><p>Platforms like <a href=https://vercel.com/>Vercel</a>, <a href=https://www.heroku.com/>Heroku</a>, <a href=https://cloud.google.com/run>Google Cloud Run</a>
and <a href=https://aws.amazon.com/ecs/>AWS ECS</a> are truly remarkable, from an engineering point of view and because they lift
the burden of deploying your application and manage your infrastructure.
Kudos to Knative and Tekton for bringing such platforms closer to our reach.</p><p>Cheers 🍺!</p><p>Thanks <a href=https://twitter.com/catileptic>@catileptic</a> for the awesome illustrations!</p></p></article></main><script>hljs.initHighlightingOnLoad()</script><footer class=footer>&copy; 2025 <a href=https://github.com/vtemian>Vlad Temian</a>,
powered by <a href=https://gohugo.io/ target=_blank>Hugo</a>,
with help from <a href=https://github.com/balajmarius>&copy;balajmarius</a>.</footer></div></body></html>